<div class="max-w-4xl mx-auto px-4" id="study-container">
  <div class="mb-6" id="header-section">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          <i class="fas fa-brain text-blue-600"></i> <%= title %>
        </h1>
        <p class="text-gray-600">
          <% if (studyType === 'long_term') { %>
            Long-term learning with spaced repetition
          <% } else if (studyType === 'random_all') { %>
            Random practice - All cards
          <% } else { %>
            Random practice - Starred cards only
          <% } %>
        </p>
      </div>
      <div class="flex space-x-2">
        <button 
          onclick="toggleFocusMode()" 
          id="focus-btn"
          class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition"
        >
          <i class="fas fa-compress-alt"></i> Focus
        </button>
        <button 
          onclick="toggleFullscreen()" 
          id="fullscreen-btn"
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition"
        >
          <i class="fas fa-expand"></i> Fullscreen
        </button>
      </div>
    </div>
  </div>

  <% if (!flashcards || flashcards.length === 0) { %>
    <!-- No flashcards -->
    <div class="bg-white p-12 rounded-lg shadow text-center">
      <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">All done!</h2>
      <p class="text-gray-600 mb-6">
        <% if (studyType === 'long_term') { %>
          No cards due for review right now. Come back later!
        <% } else { %>
          No flashcards available for this study mode.
        <% } %>
      </p>
      <a href="/dashboard" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
        <i class="fas fa-home"></i> Back to Dashboard
      </a>
    </div>
  <% } else { %>
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6" id="stats-section">
      <button onclick="filterCards('all')" id="stat-all" class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer border-2 border-blue-500">
        <p class="text-gray-600 text-sm mb-1">Total</p>
        <p class="text-2xl font-bold text-gray-800" id="stat-total"><%= flashcards.length %></p>
      </button>
      <button onclick="filterCards('mastered')" id="stat-mastered" class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer border-2 border-transparent hover:border-green-500">
        <p class="text-gray-600 text-sm mb-1">Mastered</p>
        <p class="text-2xl font-bold text-green-600" id="stat-mastered-count">0</p>
      </button>
      <button onclick="filterCards('learning')" id="stat-learning" class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer border-2 border-transparent hover:border-yellow-500">
        <p class="text-gray-600 text-sm mb-1">Learning</p>
        <p class="text-2xl font-bold text-yellow-600" id="stat-learning-count">0</p>
      </button>
      <button onclick="filterCards('new')" id="stat-new" class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer border-2 border-transparent hover:border-blue-500">
        <p class="text-gray-600 text-sm mb-1">New</p>
        <p class="text-2xl font-bold text-blue-600" id="stat-new-count">0</p>
      </button>
      <button onclick="filterCards('starred')" id="stat-starred" class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer border-2 border-transparent hover:border-yellow-500">
        <p class="text-gray-600 text-sm mb-1">Stars</p>
        <p class="text-2xl font-bold text-yellow-500" id="stat-starred-count">0</p>
      </button>
    </div>

    <!-- Study Interface -->
    <div class="bg-white rounded-lg shadow p-6 mb-4" id="flashcard-section">
      <!-- Study Mode Selector -->
      <div class="mb-4 text-center" id="mode-selector-section">
        <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
          <button 
            onclick="switchStudyMode('flashcard')" 
            id="mode-flashcard-btn"
            class="px-6 py-2 bg-white text-gray-700 font-medium transition hover:bg-gray-50"
          >
            <i class="fas fa-layer-group"></i> Flashcard
          </button>
          <button 
            onclick="switchStudyMode('multichoice')" 
            id="mode-multichoice-btn"
            class="px-6 py-2 bg-blue-600 text-white font-medium transition"
          >
            <i class="fas fa-list-ul"></i> Multi-Choice
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="mode-hint">
          <i class="fas fa-info-circle"></i> <span id="mode-hint-text">Multi-choice mode active</span>
        </p>
      </div>

      <!-- Filter Info -->
      <div class="mb-4 text-center" id="filter-info-section">
        <span id="filter-info" class="text-sm bg-blue-100 text-blue-800 px-4 py-2 rounded-full">
          <i class="fas fa-filter"></i> Showing: All Cards
        </span>
      </div>

      <!-- Progress Bar -->
      <div class="mb-6" id="progress-section">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span>Progress</span>
          <span><span id="current-card">1</span> / <span id="total-filtered"><%= flashcards.length %></span></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: <%= (1/flashcards.length)*100 %>%"></div>
        </div>
      </div>

      <!-- Flashcard -->
            <!-- Flashcard -->
      <div id="flashcard-container" class="mb-1" style="min-height: 350px;">
        <div class="flashcard">
          <div class="flashcard-inner">
            <div class="flashcard-front bg-blue-50 border-2 border-blue-200 rounded-lg">
              <div class="text-center w-full pt-8 h-full flex flex-col">
                <p class="text-sm text-gray-500 mb-1 flex-shrink-0">
                  <i class="fas fa-sync-alt"></i> Click to flip
                </p>
                <div id="word-content" class="text-2xl font-semibold text-gray-800 overflow-y-auto flex-1">
                  Loading...
                </div>
              </div>
            </div>
            
            <div class="flashcard-back bg-green-50 border-2 border-green-200 rounded-lg">
              <div class="text-center w-full pt-8 h-full flex flex-col">
                <p class="text-sm text-gray-500 mb-1 flex-shrink-0">
                  <i class="fas fa-sync-alt"></i> Click to flip
                </p>
                <div id="definition-content" class="text-xl text-gray-800 overflow-y-auto flex-1">
                  Loading...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Note Button -->
      <div class="mb-4 text-center" id="note-section">
        <button 
          onclick="showNoteDialog()" 
          id="note-btn"
          class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded-lg transition"
          style="display: none;"
        >
          <i class="fas fa-sticky-note"></i> View Note
        </button>
      </div>

      <!-- Answer Buttons (hidden in multi-choice mode) -->
      <div id="answer-buttons-section">
        <% if (studyType === 'long_term') { %>
          <div class="flex space-x-4">
            <button 
              onclick="submitAnswer(false)" 
              class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition font-semibold"
              id="incorrect-btn"
            >
              <i class="fas fa-times-circle"></i> Incorrect
            </button>
            <button 
              onclick="submitAnswer(true)" 
              class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition font-semibold"
              id="correct-btn"
            >
              <i class="fas fa-check-circle"></i> Correct
            </button>
          </div>
        <% } else { %>
          <div class="flex space-x-4">
            <button 
              onclick="nextCard()" 
              class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition font-semibold"
            >
              <i class="fas fa-arrow-right"></i> Next Card
            </button>
          </div>
        <% } %>
      </div>

      <!-- Navigation Buttons (shown after answering) -->
      <div id="navigation-buttons" class="flex space-x-4 mt-4" style="display: none;">
        <button 
          onclick="previousCard()" 
          id="prev-btn"
          class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button 
          onclick="nextCard()" 
          id="next-btn"
          class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition font-semibold"
        >
          <i class="fas fa-arrow-right"></i> Next
        </button>
      </div>

      <!-- Star Toggle -->
      <div class="mt-4 text-center" id="star-section">
        <button 
          onclick="toggleStar()" 
          id="star-btn"
          class="text-gray-400 hover:text-yellow-500 transition text-2xl"
        >
          <i class="fas fa-star"></i>
        </button>
      </div>
    </div>

    <!-- Card Info -->
    <div class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
        <span class="text-xs md:text-sm">
          <i class="fas fa-keyboard"></i> 
          <strong>Shortcuts:</strong> Space to flip, ‚Üê for Incorrect, ‚Üí for Correct
        </span>
        <span id="card-info" class="text-xs md:text-sm"></span>
      </div>
    </div>
  <% } %>
</div>

<!-- Note Dialog Modal -->
<div id="noteDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;" onclick="closeNoteDialog()">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-800">
        <i class="fas fa-sticky-note text-yellow-500"></i> Your Note
      </h3>
      <button onclick="closeNoteDialog()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    <div id="dialog-note-content" class="prose prose-sm max-w-none text-gray-700 bg-yellow-50 p-4 rounded border border-yellow-200">
      <!-- Note content will be inserted here -->
    </div>
  </div>
</div>

<script>
  const flashcards = <%- JSON.stringify(flashcards || []) %>;
  const studyType = '<%= studyType %>';
  const entityType = '<%= entityType %>';
  const entityId = '<%= entityId %>';
  let currentIndex = 0;
  let isFlipped = false;
  let currentNote = null;
  let currentFilter = 'all';
  let filteredFlashcards = [...flashcards];
  let isFullscreen = false;
  let isFocusMode = false;
  let selectedAnswer = null;
  
  // LocalStorage keys
  const storageKey = `study_filter_${entityType}_${entityId}`;
  const modeStorageKey = `study_mode_${entityType}_${entityId}`;
  
  // Load study mode from localStorage (default: multichoice)
  let studyMode = localStorage.getItem(modeStorageKey) || 'multichoice';
  let selectedAnswers = []; // Array to store multiple selected answers

  // Detect if flashcard is multi-choice
  function isMultiChoiceCard(card) {
    // Multi-choice if definition starts with "Correct: " and word has options (A. B. C. D.)
    const hasCorrectFormat = card.definition && card.definition.match(/^Correct:\s*[A-Z]/i);
    const hasOptionsFormat = card.word && card.word.match(/[A-Z]\.\s+/);
    
    return hasCorrectFormat && hasOptionsFormat;
  }

  // Count multi-choice cards
  function countMultiChoiceCards() {
    return flashcards.filter(card => isMultiChoiceCard(card)).length;
  }

  // Switch study mode
  function switchStudyMode(mode) {
    studyMode = mode;
    
    // Save to localStorage
    localStorage.setItem(modeStorageKey, mode);
    
    // Update button styles
    updateModeButtons();
    
    // Reset and re-render current card
    isFlipped = false;
    selectedAnswer = null;
    loadCard(currentIndex);
  }
  
  // Update mode button styles
  function updateModeButtons() {
    const flashcardBtn = document.getElementById('mode-flashcard-btn');
    const multichoiceBtn = document.getElementById('mode-multichoice-btn');
    
    if (studyMode === 'flashcard') {
      flashcardBtn.classList.add('bg-blue-600', 'text-white');
      flashcardBtn.classList.remove('bg-white', 'text-gray-700');
      multichoiceBtn.classList.add('bg-white', 'text-gray-700');
      multichoiceBtn.classList.remove('bg-blue-600', 'text-white');
      document.getElementById('mode-hint-text').textContent = 'Flashcard mode for all cards';
    } else {
      multichoiceBtn.classList.add('bg-blue-600', 'text-white');
      multichoiceBtn.classList.remove('bg-white', 'text-gray-700');
      flashcardBtn.classList.add('bg-white', 'text-gray-700');
      flashcardBtn.classList.remove('bg-blue-600', 'text-white');
      const multiCount = countMultiChoiceCards();
      document.getElementById('mode-hint-text').textContent = 
        `${multiCount} cards support multi-choice mode`;
    }
  }

  // Initialize stats
  function updateStats() {
    const stats = {
      total: flashcards.length,
      mastered: 0,
      learning: 0,
      new: 0,
      starred: 0
    };

    flashcards.forEach(card => {
      if (card.is_starred) stats.starred++;
      if (card.is_mastered) {
        stats.mastered++;
      } else if (card.consecutive_correct > 0) {
        stats.learning++;
      } else {
        stats.new++;
      }
    });

    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-mastered-count').textContent = stats.mastered;
    document.getElementById('stat-learning-count').textContent = stats.learning;
    document.getElementById('stat-new-count').textContent = stats.new;
    document.getElementById('stat-starred-count').textContent = stats.starred;
  }

  // Filter cards
  function filterCards(filterType) {
    currentFilter = filterType;
    
    // Save filter to localStorage
    localStorage.setItem(storageKey, filterType);
    
    // Update active state on stats cards
    document.querySelectorAll('.stat-card').forEach(card => {
      card.classList.remove('border-blue-500', 'border-green-500', 'border-yellow-500');
      card.classList.add('border-transparent');
    });

    // Filter flashcards
    switch(filterType) {
      case 'all':
        filteredFlashcards = [...flashcards];
        document.getElementById('stat-all').classList.remove('border-transparent');
        document.getElementById('stat-all').classList.add('border-blue-500');
        updateFilterInfo('all', 'All Cards', 'blue');
        break;
      case 'mastered':
        filteredFlashcards = flashcards.filter(card => card.is_mastered);
        document.getElementById('stat-mastered').classList.remove('border-transparent');
        document.getElementById('stat-mastered').classList.add('border-green-500');
        updateFilterInfo('mastered', 'Mastered Cards', 'green');
        break;
      case 'learning':
        filteredFlashcards = flashcards.filter(card => !card.is_mastered && (card.consecutive_correct > 0));
        document.getElementById('stat-learning').classList.remove('border-transparent');
        document.getElementById('stat-learning').classList.add('border-yellow-500');
        updateFilterInfo('learning', 'Learning Cards', 'yellow');
        break;
      case 'new':
        filteredFlashcards = flashcards.filter(card => !card.is_mastered && (!card.consecutive_correct || card.consecutive_correct === 0));
        document.getElementById('stat-new').classList.remove('border-transparent');
        document.getElementById('stat-new').classList.add('border-blue-500');
        updateFilterInfo('new', 'New Cards', 'blue');
        break;
      case 'starred':
        filteredFlashcards = flashcards.filter(card => card.is_starred);
        document.getElementById('stat-starred').classList.remove('border-transparent');
        document.getElementById('stat-starred').classList.add('border-yellow-500');
        updateFilterInfo('starred', 'Starred Cards', 'yellow');
        break;
    }

    // Update total filtered count
    const totalFilteredEl = document.getElementById('total-filtered');
    if (totalFilteredEl) {
      totalFilteredEl.textContent = filteredFlashcards.length;
    }

    // Check if there are cards to show
    if (filteredFlashcards.length === 0) {
      // Auto-switch to a filter with data
      const availableFilters = [
        { type: 'all', count: flashcards.length },
        { type: 'mastered', count: flashcards.filter(c => c.is_mastered).length },
        { type: 'learning', count: flashcards.filter(c => !c.is_mastered && c.consecutive_correct > 0).length },
        { type: 'new', count: flashcards.filter(c => !c.is_mastered && (!c.consecutive_correct || c.consecutive_correct === 0)).length },
        { type: 'starred', count: flashcards.filter(c => c.is_starred).length }
      ];
      
      // Find first filter with data, excluding current
      const nextFilter = availableFilters.find(f => f.count > 0 && f.type !== filterType);
      
      if (nextFilter) {
        console.log(`No cards in ${filterType}, switching to ${nextFilter.type}`);
        // Recursively call with available filter
        setTimeout(() => filterCards(nextFilter.type), 100);
        return; // Important: prevent continuing execution
      } else {
        // Truly no cards available
        showNoCardsMessage(filterType);
        return;
      }
    }
    
    // Only execute if we have cards
    currentIndex = 0;
    loadCard(0);
  }
  
  // Helper function to update filter info safely
  function updateFilterInfo(filterType, label, color) {
    const filterInfoEl = document.getElementById('filter-info');
    if (filterInfoEl) {
      filterInfoEl.innerHTML = `<i class="fas fa-filter"></i> Showing: ${label}`;
      filterInfoEl.className = `text-sm bg-${color}-100 text-${color}-800 px-4 py-2 rounded-full`;
    }
  }
  
  // Fullscreen toggle
  function toggleFocusMode() {
    isFocusMode = !isFocusMode;
    const container = document.getElementById('study-container');
    const btn = document.getElementById('focus-btn');
    const header = document.getElementById('header-section');
    const stats = document.getElementById('stats-section');
    const modeSelector = document.getElementById('mode-selector-section');
    const filterInfo = document.getElementById('filter-info-section');
    const progressSection = document.querySelector('#flashcard-section .mb-6');
    const answerButtons = document.getElementById('answer-buttons-section');
    const noteSection = document.getElementById('note-section');
    const starSection = document.getElementById('star-section');
    const cardInfo = document.querySelector('.bg-gray-50.p-4');
    const flashcardContainer = document.getElementById('flashcard-container');
    
    if (isFocusMode) {
      // Enter Focus Mode - maximize content, minimize chrome
      document.body.classList.add('focus-mode-active');
      
      // Hide ALL UI except flashcard content and answer buttons
      if (header) header.style.display = 'none';
      if (stats) stats.style.display = 'none';
      if (modeSelector) modeSelector.style.display = 'none';
      if (filterInfo) filterInfo.style.display = 'none';
      if (progressSection) progressSection.style.display = 'none';
      // Keep answer buttons visible in focus mode for flashcard interaction
      // if (answerButtons) answerButtons.style.display = 'none';
      if (noteSection) noteSection.style.display = 'none';
      if (starSection) starSection.style.display = 'none';
      if (cardInfo) cardInfo.style.display = 'none';
      
      // Maximize flashcard container
      container.classList.add('focus-mode-container');
      if (flashcardContainer) {
        flashcardContainer.style.minHeight = 'calc(100vh - 60px)';
        flashcardContainer.style.height = 'calc(100vh - 60px)';
      }
      
      // Update button to Exit - ALWAYS VISIBLE
      btn.innerHTML = '<i class="fas fa-times"></i> Exit';
      btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
      btn.classList.add('bg-red-500', 'hover:bg-red-600');
      btn.style.position = 'fixed';
      btn.style.top = '0.5rem';
      btn.style.right = '0.5rem';
      btn.style.zIndex = '9999';
      btn.style.display = 'flex';
      
      // Show temporary hint
      const hint = document.createElement('div');
      hint.id = 'focus-hint';
      hint.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white px-6 py-3 rounded-lg text-sm z-40 shadow-lg';
      hint.innerHTML = '<i class="fas fa-compress-alt"></i> Focus Mode Active - Press ESC or click Exit';
      document.body.appendChild(hint);
      
      setTimeout(() => {
        const hintEl = document.getElementById('focus-hint');
        if (hintEl) {
          hintEl.style.transition = 'opacity 0.5s';
          hintEl.style.opacity = '0';
          setTimeout(() => hintEl.remove(), 500);
        }
      }, 2000);
      
    } else {
      // Exit Focus Mode
      document.body.classList.remove('focus-mode-active');
      
      // Show all elements
      if (header) header.style.display = 'block';
      if (stats) stats.style.display = 'grid';
      if (modeSelector) modeSelector.style.display = 'block';
      if (filterInfo) filterInfo.style.display = 'block';
      if (progressSection) progressSection.style.display = 'block';
      if (answerButtons) answerButtons.style.display = 'block';
      if (noteSection) noteSection.style.display = 'block';
      if (starSection) starSection.style.display = 'block';
      if (cardInfo) cardInfo.style.display = 'flex';
      
      // Restore container
      container.classList.remove('focus-mode-container');
      if (flashcardContainer) {
        flashcardContainer.style.minHeight = '350px';
        flashcardContainer.style.height = 'auto';
      }
      
      // Restore button
      btn.innerHTML = '<i class="fas fa-compress-alt"></i> Focus';
      btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
      btn.classList.remove('bg-red-500', 'hover:bg-red-600');
      btn.style.position = '';
      btn.style.top = '';
      btn.style.right = '';
      btn.style.zIndex = '';
      
      // Remove hint
      const hint = document.getElementById('focus-hint');
      if (hint) hint.remove();
    }
  }

  function toggleFullscreen() {
    isFullscreen = !isFullscreen;
    const container = document.getElementById('study-container');
    const btn = document.getElementById('fullscreen-btn');
    const header = document.getElementById('header-section');
    const stats = document.getElementById('stats-section');
    const filterInfo = document.getElementById('filter-info-section');
    const flashcardSection = document.getElementById('flashcard-section');
    const cardInfo = document.querySelector('.bg-gray-50.p-4');
    const noteSection = document.getElementById('note-section');
    const starSection = document.getElementById('star-section');
    
    if (isFullscreen) {
      // Enter fullscreen mode
      container.classList.remove('max-w-4xl', 'mx-auto');
      container.classList.add('fixed', 'inset-0', 'bg-gray-100', 'z-50', 'overflow-y-auto', 'p-2', 'md:p-4', 'fullscreen-mode');
      
      // Hide unnecessary elements for focus - KEEP note section visible
      if (header) header.style.display = 'none';
      if (stats) stats.style.display = 'none';
      if (filterInfo) filterInfo.style.display = 'none';
      if (cardInfo) cardInfo.style.display = 'none';
      // Note section stays visible - removed from hide list
      if (starSection) starSection.style.display = 'none';
      
      // Optimize flashcard section
      flashcardSection.classList.remove('p-6', 'mb-4', 'shadow');
      flashcardSection.classList.add('p-1', 'mb-0');
      
      // Add focus mode hint
      const hint = document.createElement('div');
      hint.id = 'fullscreen-hint';
      hint.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-full text-sm z-40';
      hint.innerHTML = '<i class="fas fa-eye"></i> Focus Mode - Press F or ESC to exit';
      container.appendChild(hint);
      
      // Auto hide hint after 3 seconds
      setTimeout(() => {
        const hintEl = document.getElementById('fullscreen-hint');
        if (hintEl) {
          hintEl.style.transition = 'opacity 0.5s';
          hintEl.style.opacity = '0';
          setTimeout(() => hintEl.remove(), 500);
        }
      }, 3000);
      
      btn.innerHTML = '<i class="fas fa-compress"></i>';
      btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
      btn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'fixed', 'top-2', 'right-2', 'z-50', 'px-3', 'py-2', 'shadow-lg');
      
      // Try native fullscreen API
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log('Fullscreen request failed:', err);
        });
      }
    } else {
      // Exit fullscreen mode
      container.classList.add('max-w-4xl', 'mx-auto');
      container.classList.remove('fixed', 'inset-0', 'bg-gray-100', 'z-50', 'overflow-y-auto', 'p-2', 'md:p-4', 'fullscreen-mode');
      
      // Remove hint if exists
      const hint = document.getElementById('fullscreen-hint');
      if (hint) hint.remove();
      
      // Show all elements
      if (header) header.style.display = 'block';
      if (stats) stats.style.display = 'grid';
      if (filterInfo) filterInfo.style.display = 'block';
      if (cardInfo) cardInfo.style.display = 'flex';
      if (noteSection) noteSection.style.display = 'block';
      if (starSection) starSection.style.display = 'block';
      
      // Restore flashcard section
      flashcardSection.classList.add('p-6', 'mb-4', 'shadow');
      flashcardSection.classList.remove('p-1', 'mb-0');
      
      btn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
      btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
      btn.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white', 'fixed', 'top-2', 'right-2', 'z-50', 'px-3', 'py-2', 'shadow-lg');
      
      // Exit native fullscreen
      if (document.exitFullscreen) {
        document.exitFullscreen().catch(err => {
          console.log('Exit fullscreen failed:', err);
        });
      }
    }
  }
  
  // Listen for fullscreen changes
  document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement && isFullscreen) {
      // User pressed ESC or exited fullscreen via browser
      toggleFullscreen();
    }
  });

  function showNoCardsMessage(filterType) {
    const filterNames = {
      'all': 'All',
      'mastered': 'Mastered',
      'learning': 'Learning',
      'new': 'New',
      'starred': 'Starred'
    };
    
    const container = document.getElementById('flashcard-container').parentElement;
    container.innerHTML = `
      <div class="text-center py-12">
        <i class="fas fa-inbox text-6xl text-gray-400 mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">No ${filterNames[filterType]} Cards</h2>
        <p class="text-gray-600 mb-6">Try selecting a different filter.</p>
        <button onclick="filterCards('all')" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
          <i class="fas fa-filter"></i> Show All Cards
        </button>
      </div>
    `;
  }

  function loadCard(index) {
    if (index >= filteredFlashcards.length) {
      showCompletion();
      return;
    }

    const card = filteredFlashcards[index];
    currentIndex = index;
    selectedAnswer = null;
    selectedAnswers = []; // Reset selected answers array for new card
    
    // Reset button visibility
    document.getElementById('answer-buttons-section').style.display = 'block';
    document.getElementById('navigation-buttons').style.display = 'none';
    
    // Check if multi-choice mode and card supports it
    const isMultiChoice = studyMode === 'multichoice' && isMultiChoiceCard(card);
    
    // Show/hide answer buttons based on mode
    const answerButtonsSection = document.getElementById('answer-buttons-section');
    if (isMultiChoice) {
      answerButtonsSection.style.display = 'none'; // Hide Correct/Incorrect buttons
    } else {
      answerButtonsSection.style.display = 'block'; // Show normal buttons
    }
    
    // Important: Reset flip state BEFORE updating content
    const flashcardElement = document.querySelector('.flashcard');
    flashcardElement.classList.remove('flipped');
    isFlipped = false;

    // Small delay to ensure DOM is ready
    setTimeout(() => {
      if (isMultiChoice) {
        // Render as multi-choice question
        renderMultiChoiceCard(card);
      } else {
        // Render as regular flashcard
        document.getElementById('word-content').innerHTML = formatContent(card.word);
        document.getElementById('definition-content').innerHTML = formatContent(card.definition);
      }

      // Update progress
      document.getElementById('current-card').textContent = index + 1;
      const progress = ((index + 1) / filteredFlashcards.length) * 100;
      document.getElementById('progress-bar').style.width = progress + '%';

      // Update star button
      const starBtn = document.getElementById('star-btn');
      if (card.is_starred) {
        starBtn.innerHTML = '<i class="fas fa-star text-yellow-500"></i>';
      } else {
        starBtn.innerHTML = '<i class="far fa-star"></i>';
      }

      // Handle note button
      currentNote = card.user_note || null;
      const noteBtn = document.getElementById('note-btn');
      if (currentNote) {
        noteBtn.style.display = 'inline-block';
      } else {
        noteBtn.style.display = 'none';
      }

      // Update card info
      if (card.consecutive_correct !== undefined) {
        document.getElementById('card-info').textContent = 
          `Streak: ${card.consecutive_correct || 0} | ${card.is_mastered ? 'Mastered ‚úì' : 'Learning'}`;
      }
    }, 50);
  }

  function renderMultiChoiceCard(card) {
    // Parse question and options from word (not term!)
    let wordContent = card.word;
    
    // Split by YYY to separate question+options from note
    if (wordContent.includes('YYY')) {
      wordContent = wordContent.split('YYY')[0]; // Get only question+options part
    }
    
    const lines = wordContent.split('\n');
    const question = lines[0];
    const options = [];
    
    // Extract options (A. B. C. D.)
    lines.forEach(line => {
      const match = line.match(/^([A-Z])\.\s+(.+)/);
      if (match) {
        options.push({ letter: match[1], text: match[2] });
      }
    });
    
    // Extract correct answer from definition (Correct: A or Correct: A, C)
    const correctMatch = card.definition.match(/Correct:\s*([A-Z,\s]+)/i);
    const correctAnswers = correctMatch ? correctMatch[1].split(',').map(a => a.trim()) : [];
    
    // Determine if this is multi-choice (more than 1 correct answer) or single-choice
    const isMultiSelect = correctAnswers.length > 1;
    
    // Build HTML - Different display for single vs multi select
    const instructionText = isMultiSelect ? 
      `<i class="fas fa-check-square"></i> Choose ALL correct answers (${correctAnswers.length} answers)` : 
      'Choose one answer';
    
    let html = `<div class="mc-container">
      <div class="mc-header">
        <span class="mc-label">Term</span>
      </div>
      <p class="mc-question">${question}</p>
      <div class="mc-instruction">${instructionText}</div>
      <div class="mc-options">`;
    
    options.forEach((opt, index) => {
      // Use checkbox icon for multi-select, letter for single-select
      const indicator = isMultiSelect ? 
        `<div class="mc-checkbox"><i class="far fa-square"></i></div>` : 
        `<div class="mc-number">${opt.letter}</div>`;
      
      html += `
        <div class="mc-option" data-answer="${opt.letter}" data-multi="${isMultiSelect}">
          ${indicator}
          <div class="mc-text">${opt.text}</div>
        </div>`;
    });
    
    html += `
      </div>
      <button onclick="checkMultiChoiceAnswer()" id="check-answer-btn" class="mc-btn" disabled>
        <i class="fas fa-check-circle"></i> Check Answer
      </button>
      <button onclick="skipQuestion()" class="mc-btn-secondary">
        <i class="fas fa-forward"></i> Don't know?
      </button>
    </div>`;
    
    document.getElementById('word-content').innerHTML = html;
    
    // Show correct answer on back (for flip mode)
    document.getElementById('definition-content').innerHTML = 
      `<div class="text-left"><p class="text-lg mb-2">Correct Answer:</p><p class="text-2xl font-bold text-green-600">${correctAnswers.join(', ')}</p></div>`;
    
    // Add event listeners to options
    document.querySelectorAll('.mc-option').forEach(option => {
      option.addEventListener('click', function() {
        const answer = this.dataset.answer;
        const isMulti = this.dataset.multi === 'true';
        
        if (isMulti) {
          // Multi-select: Toggle selection
          if (this.classList.contains('selected')) {
            // Deselect
            this.classList.remove('selected');
            const checkbox = this.querySelector('.mc-checkbox i');
            checkbox.className = 'far fa-square';
            selectedAnswers = selectedAnswers.filter(a => a !== answer);
          } else {
            // Select
            this.classList.add('selected');
            const checkbox = this.querySelector('.mc-checkbox i');
            checkbox.className = 'fas fa-check-square';
            selectedAnswers.push(answer);
          }
        } else {
          // Single-select: Clear all and select this one
          document.querySelectorAll('.mc-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
          selectedAnswers = [answer];
        }
        
        // Enable check button if at least one answer is selected
        document.getElementById('check-answer-btn').disabled = selectedAnswers.length === 0;
      });
    });
  }
  
  function skipQuestion() {
    // Skip to next card without answering
    if (studyType === 'long_term') {
      submitAnswer(false); // Mark as incorrect
    } else {
      nextCard();
    }
  }

  function checkMultiChoiceAnswer() {
    if (selectedAnswers.length === 0) return;
    
    const card = filteredFlashcards[currentIndex];
    const correctMatch = card.definition.match(/Correct:\s*([A-Z,\s]+)/i);
    const correctAnswers = correctMatch ? correctMatch[1].split(',').map(a => a.trim()) : [];
    
    // Sort both arrays to compare
    const sortedSelected = [...selectedAnswers].sort();
    const sortedCorrect = [...correctAnswers].sort();
    
    // Check if arrays are equal (all correct answers selected, no wrong answers)
    const isCorrect = sortedSelected.length === sortedCorrect.length && 
                      sortedSelected.every((val, index) => val === sortedCorrect[index]);
    
    // Disable all options (prevent changing answer)
    document.querySelectorAll('.mc-option').forEach(option => {
      option.style.pointerEvents = 'none';
    });
    
    // Highlight answers with checkmark/cross
    document.querySelectorAll('.mc-option').forEach(option => {
      const letter = option.dataset.answer;
      const isMulti = option.dataset.multi === 'true';
      const indicatorEl = isMulti ? option.querySelector('.mc-checkbox i') : option.querySelector('.mc-number');
      const isSelected = selectedAnswers.includes(letter);
      const isCorrectAnswer = correctAnswers.includes(letter);
      
      if (isCorrectAnswer) {
        // Correct answer - show green checkmark
        option.classList.add('correct');
        if (isMulti) {
          indicatorEl.className = 'fas fa-check-circle';
        } else {
          indicatorEl.innerHTML = '<i class="fas fa-check"></i>';
        }
      } else if (isSelected && !isCorrectAnswer) {
        // Wrong answer that user selected - show red X
        option.classList.add('incorrect');
        if (isMulti) {
          indicatorEl.className = 'fas fa-times-circle';
        } else {
          indicatorEl.innerHTML = '<i class="fas fa-times"></i>';
        }
      }
      
      // Remove selected state after checking
      option.classList.remove('selected');
    });
    
    // Update check button to show result
    const checkBtn = document.getElementById('check-answer-btn');
    checkBtn.disabled = true;
    checkBtn.classList.remove('mc-btn');
    checkBtn.classList.add(isCorrect ? 'mc-btn-correct' : 'mc-btn-incorrect');
    checkBtn.innerHTML = isCorrect ? 
      '<i class="fas fa-check-circle"></i> Correct!' : 
      '<i class="fas fa-times-circle"></i> Incorrect';
    
    // Hide skip button
    const skipBtn = document.querySelector('.mc-btn-secondary');
    if (skipBtn) skipBtn.style.display = 'none';
    
    // Show navigation buttons after answering
    document.getElementById('answer-buttons-section').style.display = 'none';
    document.getElementById('navigation-buttons').style.display = 'flex';
    
    // Update prev button state
    updateNavigationButtons();
    
    // Submit answer to server if long-term study
    if (studyType === 'long_term') {
      submitAnswerToServer(isCorrect);
    }
  }

  function formatContent(content) {
    // Handle YYY separator for notes
    if (content.includes('YYY')) {
      const parts = content.split('YYY');
      return '<div class="text-left">' + 
             parts[0].replace(/\n/g, '<br>').replace(/^([A-D]\.)/gm, '<strong>$1</strong>') + 
             '</div>';
    }
    
    // Basic formatting for multiple choice questions
    if (content.includes('\nA.') || content.includes('\nB.')) {
      return '<div class="text-left">' + 
             content.replace(/\n/g, '<br>').replace(/^([A-D]\.)/gm, '<strong>$1</strong>') + 
             '</div>';
    }
    return content.replace(/\n/g, '<br>');
  }

  function flipCard() {
    // Don't flip if in multi-choice mode
    if (studyMode === 'multichoice') {
      return;
    }
    
    const flashcard = document.querySelector('.flashcard');
    if (flashcard) {
      flashcard.classList.toggle('flipped');
      isFlipped = !isFlipped;
    }
  }
  
  // Add click event to flashcard
  document.addEventListener('DOMContentLoaded', function() {
    const flashcard = document.querySelector('.flashcard');
    if (flashcard) {
      flashcard.addEventListener('click', flipCard);
    }
  });

  function showNoteDialog() {
    if (currentNote) {
      document.getElementById('dialog-note-content').innerHTML = formatContent(currentNote);
      document.getElementById('noteDialog').style.display = 'flex';
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }
  }

  function closeNoteDialog() {
    document.getElementById('noteDialog').style.display = 'none';
    // Restore body scroll
    document.body.style.overflow = 'auto';
  }

  function nextCard() {
    loadCard(currentIndex + 1);
  }

  function submitAnswer(isCorrect) {
    // Hide answer buttons, show navigation
    document.getElementById('answer-buttons-section').style.display = 'none';
    document.getElementById('navigation-buttons').style.display = 'flex';
    updateNavigationButtons();
    
    // Submit to server
    submitAnswerToServer(isCorrect);
  }

  function submitAnswerToServer(isCorrect) {
    const card = filteredFlashcards[currentIndex];

    // Send answer to server
    fetch('/study/answer', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        flashcard_id: card.id,
        is_correct: isCorrect
      })
    })
    .then(response => response.json())
    .then(data => {
      // Update local card data
      const originalCard = flashcards.find(c => c.id === card.id);
      if (originalCard) {
        if (isCorrect) {
          originalCard.consecutive_correct = (originalCard.consecutive_correct || 0) + 1;
          // Check if mastered (e.g., 3 consecutive correct)
          if (originalCard.consecutive_correct >= 3) {
            originalCard.is_mastered = true;
          }
        } else {
          originalCard.consecutive_correct = 0;
          originalCard.is_mastered = false;
        }
      }
      
      // Update stats
      updateStats();
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }

  function previousCard() {
    if (currentIndex > 0) {
      loadCard(currentIndex - 1);
    }
  }

  function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    if (prevBtn) {
      prevBtn.disabled = currentIndex === 0;
    }
  }

  function toggleStar() {
    const card = filteredFlashcards[currentIndex];

    fetch(`/flashcards/${card.id}/toggle-star`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      // Toggle star state in both arrays
      const originalCard = flashcards.find(c => c.id === card.id);
      if (originalCard) {
        originalCard.is_starred = originalCard.is_starred ? 0 : 1;
      }
      card.is_starred = card.is_starred ? 0 : 1;
      
      const starBtn = document.getElementById('star-btn');
      if (card.is_starred) {
        starBtn.innerHTML = '<i class="fas fa-star text-yellow-500"></i>';
      } else {
        starBtn.innerHTML = '<i class="far fa-star"></i>';
      }
      
      // Update stats
      updateStats();
      
      // If filtering by starred, re-apply filter
      if (currentFilter === 'starred') {
        filterCards('starred');
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function showCompletion() {
    const container = document.getElementById('flashcard-container').parentElement;
    container.innerHTML = `
      <div class="text-center py-12">
        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Great job!</h2>
        <p class="text-gray-600 mb-6">You've completed this study session.</p>
        <div class="space-x-4">
          <a href="/dashboard" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
            <i class="fas fa-home"></i> Dashboard
          </a>
          <button onclick="location.reload()" class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
            <i class="fas fa-redo"></i> Study Again
          </button>
        </div>
      </div>
    `;
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    switch(e.key) {
      case ' ':
        e.preventDefault();
        flipCard();
        break;
      case 'ArrowLeft':
        if (studyType === 'long_term' && isFlipped) {
          submitAnswer(false);
        }
        break;
      case 'ArrowRight':
        if (studyType === 'long_term' && isFlipped) {
          submitAnswer(true);
        } else if (studyType !== 'long_term') {
          nextCard();
        }
        break;
    }
  });

  // Initialize on page load
  if (flashcards.length > 0) {
    updateStats();
    
    // Initialize mode buttons based on saved preference
    updateModeButtons();
    
    // Restore filter from localStorage
    const savedFilter = localStorage.getItem(storageKey);
    if (savedFilter && ['all', 'mastered', 'learning', 'new', 'starred'].includes(savedFilter)) {
      filterCards(savedFilter);
    } else {
      loadCard(0);
    }
  }
  
  // Keyboard shortcut for fullscreen (F key) and Focus Mode (ESC to exit)
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.key === 'f' || e.key === 'F') {
      toggleFullscreen();
    }
    
    // ESC to exit Focus Mode
    if (e.key === 'Escape' && isFocusMode) {
      toggleFocusMode();
    }
  });
</script>

<style>
  /* Container styling - prevent overflow */
  #study-container {
    width: 100%;
    box-sizing: border-box;
  }
  
  /* Ensure all child elements respect container padding */
  #study-container > * {
    box-sizing: border-box;
  }
  
  /* Flashcard 3D Flip Animation */
  .flashcard {
    perspective: 1000px;
    width: 100%;
    height: 350px;
    cursor: pointer;
  }
  
  .flashcard-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  
  .flashcard.flipped .flashcard-inner {
    transform: rotateY(180deg);
  }
  
  .flashcard-front,
  .flashcard-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
  }
  
  /* Hide overflow when containing multi-choice */
  .flashcard-front:has(.mc-container),
  .flashcard-back:has(.mc-container) {
    overflow: hidden;
  }
  
  .flashcard-front {
    background-color: #dbeafe;
  }
  
  .flashcard-back {
    background-color: #d1fae5;
    transform: rotateY(180deg);
  }

  /* Multi-line text support */
  #word-content,
  #definition-content {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* Hide scrollbar for multi-choice content */
  #word-content:has(.mc-container) {
    overflow: hidden !important;
  }
  
  #word-content:has(.mc-container)::-webkit-scrollbar {
    display: none !important;
  }
  
  #word-content:has(.mc-container) {
    -ms-overflow-style: none !important;
    scrollbar-width: none !important;
  }
  
  .flashcard:hover .flashcard-front {
    background-color: #bfdbfe;
  }
  
  .flashcard:hover .flashcard-back {
    background-color: #a7f3d0;
  }
  
  /* Fullscreen optimizations */
  #study-container.fullscreen-mode {
    padding: 0 !important;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  #study-container.fullscreen-mode #flashcard-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: transparent;
  }
  
  #study-container.fullscreen-mode .flashcard {
    height: 98vh;
    max-height: 98vh;
  }
  
  #study-container.fullscreen-mode .flashcard-inner {
    height: 100%;
  }
  
  #study-container.fullscreen-mode .flashcard-front,
  #study-container.fullscreen-mode .flashcard-back {
    height: 100%;
    overflow: hidden;
  }
  
  #study-container.fullscreen-mode #word-content,
  #study-container.fullscreen-mode #definition-content {
    font-size: clamp(1.5rem, 5vw, 3rem);
    padding: 1rem;
    max-width: 100%;
    line-height: 1.4;
    overflow-y: auto;
    max-height: calc(98vh - 200px);
  }
  
  /* Hide scrollbar for multi-choice in fullscreen */
  #study-container.fullscreen-mode #word-content:has(.mc-container) {
    overflow: hidden !important;
  }
  
  /* Multi-Choice Styles - Quizlet-inspired */
  .mc-container {
    text-align: left;
    width: 100%;
    padding: 0.75rem;
    overflow-y: auto;
    max-height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .mc-header {
    margin-bottom: 0.75rem;
    flex-shrink: 0;
  }
  
  .mc-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #6b7280;
    letter-spacing: 0.05em;
  }
  
  .mc-question {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    line-height: 1.4;
    color: #1f2937;
    word-wrap: break-word;
    overflow-wrap: break-word;
    flex-shrink: 0;
  }
  
  .mc-instruction {
    font-size: 0.8125rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
    font-weight: 500;
    flex-shrink: 0;
  }
  
  .mc-options {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.6rem;
    margin-bottom: 1rem;
    flex-shrink: 0;
  }
  
  /* Desktop styles */
  @media (min-width: 768px) {
    .mc-container {
      padding: 1rem;
    }
    
    .mc-header {
      margin-bottom: 1rem;
    }
    
    .mc-label {
      font-size: 0.875rem;
    }
    
    .mc-question {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .mc-instruction {
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .mc-options {
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
  }
  
  .mc-option {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 3.5rem;
  }
  
  @media (min-width: 768px) {
    .mc-option {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      min-height: 4rem;
    }
  }
  
  .mc-option:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
  }
  
  .mc-option.selected {
    border-color: #3b82f6;
    background: #eff6ff;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
  }
  
  .mc-option.correct {
    border-color: #10b981;
    background: #d1fae5;
    cursor: not-allowed;
  }
  
  .mc-option.incorrect {
    border-color: #ef4444;
    background: #fee2e2;
    cursor: not-allowed;
  }
  
  .mc-number {
    width: 2rem;
    height: 2rem;
    min-width: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    color: #4b5563;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.875rem;
    margin-right: 0.75rem;
    transition: all 0.2s ease;
  }

  /* Checkbox style for multi-select */
  .mc-checkbox {
    width: 2rem;
    height: 2rem;
    min-width: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4b5563;
    font-size: 1.25rem;
    margin-right: 0.75rem;
    transition: all 0.2s ease;
  }

  .mc-option.selected .mc-checkbox {
    color: #3b82f6;
  }

  .mc-option:hover .mc-checkbox {
    color: #3b82f6;
  }
  
  @media (min-width: 768px) {
    .mc-number {
      width: 2.5rem;
      height: 2.5rem;
      min-width: 2.5rem;
      font-size: 1.125rem;
      margin-right: 1rem;
    }

    .mc-checkbox {
      width: 2.5rem;
      height: 2.5rem;
      min-width: 2.5rem;
      font-size: 1.5rem;
      margin-right: 1rem;
    }
  }
  
  .mc-option:hover .mc-number {
    background: #3b82f6;
    color: white;
  }
  
  .mc-option.selected .mc-number {
    background: #3b82f6;
    color: white;
  }
  
  .mc-option.correct .mc-number {
    background: #10b981;
    color: white;
    font-size: 1rem;
  }

  .mc-option.correct .mc-checkbox {
    color: #10b981;
  }
  
  @media (min-width: 768px) {
    .mc-option.correct .mc-number,
    .mc-option.incorrect .mc-number {
      font-size: 1.25rem;
    }
  }
  
  .mc-option.incorrect .mc-number {
    background: #ef4444;
    color: white;
    font-size: 1rem;
  }

  .mc-option.incorrect .mc-checkbox {
    color: #ef4444;
  }
  
  .mc-text {
    flex: 1;
    font-size: 0.9375rem;
    line-height: 1.5;
    color: #1f2937;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  
  @media (min-width: 768px) {
    .mc-text {
      font-size: 1.125rem;
    }
  }
  
  .mc-btn {
    width: 100%;
    background: #3b82f6;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    flex-shrink: 0;
  }
  
  @media (min-width: 768px) {
    .mc-btn {
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
  }
  
  .mc-btn:hover:not(:disabled) {
    background: #2563eb;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    transform: translateY(-1px);
  }
  
  .mc-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .mc-btn-secondary {
    width: 100%;
    background: transparent;
    color: #6b7280;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: 2px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  @media (min-width: 768px) {
    .mc-btn-secondary {
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 1rem;
    }
  }
  
  .mc-btn-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }
  
  .mc-btn-correct {
    width: 100%;
    background: #10b981;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: none;
    cursor: default;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
    flex-shrink: 0;
  }
  
  @media (min-width: 768px) {
    .mc-btn-correct {
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
  }
  
  .mc-btn-incorrect {
    width: 100%;
    background: #ef4444;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: none;
    cursor: default;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
    flex-shrink: 0;
  }
  
  @media (min-width: 768px) {
    .mc-btn-incorrect {
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
  }
  
  /* Focus Mode - Centered, Clean Layout with 98vw/98vh limit */
  body.focus-mode-active {
    overflow: hidden;
    margin: 0;
    padding: 0;
  }
  
  body.focus-mode-active #study-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    max-width: none !important;
    width: 100vw !important;
    height: 100vh !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: #f3f4f6 !important;
  }
  
  body.focus-mode-active #flashcard-section {
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  body.focus-mode-active #flashcard-container {
    width: 98vw !important;
    max-width: 98vw !important;
    height: calc(98vh - 7rem) !important; /* Subtract space for progress bar and buttons */
    max-height: calc(98vh - 7rem) !important;
    margin: 0 auto !important;
    margin-top: 4rem !important; /* Space for progress bar at top */
    padding: 0 !important;
    padding-bottom: 4.5rem !important; /* Space for answer buttons at bottom */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-sizing: border-box !important;
  }
  
  body.focus-mode-active .flashcard {
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
  }
  
  body.focus-mode-active .flashcard-inner {
    width: 100% !important;
    height: 100% !important;
  }
  
  body.focus-mode-active .flashcard-front,
  body.focus-mode-active .flashcard-back {
    width: 100% !important;
    height: 100% !important;
    padding: 0.5rem !important; /* Smaller padding on mobile */
    margin: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow: hidden !important;
  }
  
  /* Exit button - Always visible in Focus Mode */
  body.focus-mode-active #focus-btn {
    position: fixed !important;
    top: 0.25rem !important;
    right: 0.25rem !important;
    z-index: 9999 !important;
    background: #ef4444 !important;
    color: white !important;
    padding: 0.5rem 0.875rem !important;
    font-size: 0.75rem !important;
    border-radius: 0.375rem !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.375rem !important;
  }
  
  /* Content scaling - Mobile optimized for 98% display */
  body.focus-mode-active #word-content {
    font-size: clamp(0.75rem, 2.5vw, 1.25rem) !important; /* Smaller on mobile */
    line-height: 1.4 !important;
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important; /* Center text on mobile */
    overflow-y: auto !important;
    padding: 0.5rem !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  
  body.focus-mode-active #definition-content {
    font-size: clamp(0.875rem, 3vw, 1.5rem) !important; /* Smaller on mobile */
    line-height: 1.4 !important;
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    overflow-y: auto !important;
    padding: 0.5rem !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  
  /* Multi-choice in focus mode - Mobile optimized */
  body.focus-mode-active .mc-header {
    display: none;
  }
  
  body.focus-mode-active .mc-container {
    padding: 0.5rem !important; /* Minimal padding on mobile */
    margin: 0 auto !important; /* Center horizontally */
    max-height: 100% !important;
    height: 100% !important;
    overflow-y: auto !important;
    width: 100% !important;
    box-sizing: border-box !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important; /* Center content */
    justify-content: center !important; /* Center vertically */
  }
  
  body.focus-mode-active .mc-question {
    font-size: clamp(0.875rem, 3vw, 1.5rem) !important; /* Smaller on mobile */
    margin-bottom: 0.5rem !important;
    line-height: 1.3 !important;
    flex-shrink: 0 !important;
    text-align: center !important; /* Center text */
    width: 100% !important;
  }
  
  body.focus-mode-active .mc-instruction {
    font-size: clamp(0.625rem, 1.5vw, 0.875rem) !important; /* Smaller on mobile */
    margin-bottom: 0.5rem !important;
    flex-shrink: 0 !important;
    text-align: center !important; /* Center text */
  }
  
  body.focus-mode-active .mc-options {
    gap: 0.375rem !important; /* Tighter gap on mobile */
    margin-bottom: 0.625rem !important;
    flex-shrink: 0 !important;
    width: 100% !important; /* Full width for options */
  }
  
  body.focus-mode-active .mc-option {
    padding: 0.5rem 0.625rem !important; /* Compact on mobile */
    min-height: auto !important;
    width: 100% !important; /* Full width options */
  }
  
  body.focus-mode-active .mc-number {
    width: 1.5rem !important; /* Smaller on mobile */
    height: 1.5rem !important;
    min-width: 1.5rem !important;
    font-size: 0.75rem !important;
    margin-right: 0.5rem !important;
  }
  
  body.focus-mode-active .mc-option.correct .mc-number,
  body.focus-mode-active .mc-option.incorrect .mc-number {
    font-size: 0.8125rem !important;
  }
  
  body.focus-mode-active .mc-text {
    font-size: clamp(0.75rem, 2.5vw, 1rem) !important; /* Smaller on mobile */
    line-height: 1.3 !important;
  }
  
  body.focus-mode-active .mc-btn,
  body.focus-mode-active .mc-btn-correct,
  body.focus-mode-active .mc-btn-incorrect,
  body.focus-mode-active .mc-btn-secondary {
    font-size: clamp(0.75rem, 2vw, 0.9375rem) !important; /* Smaller on mobile */
    padding: 0.625rem 0.875rem !important;
    margin-bottom: 0.375rem !important;
    flex-shrink: 0 !important;
  }
  
  /* Answer buttons in Focus Mode - Fixed at bottom on mobile */
  body.focus-mode-active #answer-buttons-section {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 0.5rem !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1) !important;
    z-index: 50 !important;
    margin: 0 !important;
  }
  
  body.focus-mode-active #answer-buttons-section button {
    font-size: clamp(0.875rem, 2.5vw, 1rem) !important;
    padding: 0.75rem 1rem !important;
    font-weight: 600 !important;
  }

  /* Navigation buttons in Focus Mode - Fixed at bottom */
  body.focus-mode-active #navigation-buttons {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 0.5rem !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1) !important;
    z-index: 50 !important;
    margin: 0 !important;
    display: flex !important;
  }

  body.focus-mode-active #navigation-buttons button {
    font-size: clamp(0.875rem, 2.5vw, 1rem) !important;
    padding: 0.75rem 1rem !important;
    font-weight: 600 !important;
  }

  /* Progress bar in Focus Mode - Fixed at top */
  body.focus-mode-active #progress-section {
    position: fixed !important;
    top: 3.5rem !important;
    left: 0 !important;
    right: 0 !important;
    padding: 0.5rem 1rem !important;
    background: rgba(255, 255, 255, 0.9) !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
    z-index: 40 !important;
    margin: 0 !important;
    margin-bottom: 0 !important;
    display: block !important;
  }
  
  /* Desktop enhancements for Focus Mode */
  @media (min-width: 768px) {
    body.focus-mode-active #flashcard-container {
      margin-top: 5rem !important; /* More space for desktop progress bar */
      padding-bottom: 5.5rem !important; /* More space for desktop buttons */
    }
    
    body.focus-mode-active .flashcard-front,
    body.focus-mode-active .flashcard-back {
      padding: 2rem !important;
    }
    
    body.focus-mode-active #focus-btn {
      top: 1rem !important;
      right: 1rem !important;
      padding: 0.875rem 1.5rem !important;
      font-size: 1rem !important;
    }
    
    body.focus-mode-active #word-content {
      padding: 2rem !important;
      font-size: clamp(1.25rem, 2.5vw, 2rem) !important;
      line-height: 1.5 !important;
      text-align: center !important; /* Keep centered on desktop too */
    }
    
    body.focus-mode-active #definition-content {
      padding: 2rem !important;
      font-size: clamp(1.5rem, 3vw, 2.5rem) !important;
      line-height: 1.5 !important;
      text-align: center !important;
    }
    
    body.focus-mode-active .mc-container {
      padding: 2rem !important;
      max-width: 1000px !important; /* Limit width on large screens */
    }
    
    body.focus-mode-active .mc-question {
      font-size: clamp(1.5rem, 3vw, 2.25rem) !important;
      margin-bottom: 1rem !important;
      line-height: 1.4 !important;
      text-align: center !important; /* Center on desktop too */
    }
    
    body.focus-mode-active .mc-instruction {
      font-size: 1rem !important;
      margin-bottom: 0.75rem !important;
      text-align: center !important; /* Center on desktop too */
    }
    
    body.focus-mode-active .mc-option {
      padding: 0.875rem 1.125rem !important;
    }
    
    body.focus-mode-active .mc-options {
      gap: 0.625rem !important;
      margin-bottom: 1.25rem !important;
    }
    
    body.focus-mode-active .mc-number {
      width: 2.25rem !important;
      height: 2.25rem !important;
      min-width: 2.25rem !important;
      font-size: 1rem !important;
      margin-right: 0.875rem !important;
    }
    
    body.focus-mode-active .mc-option.correct .mc-number,
    body.focus-mode-active .mc-option.incorrect .mc-number {
      font-size: 1.125rem !important;
    }
    
    body.focus-mode-active .mc-text {
      font-size: clamp(1.125rem, 2vw, 1.5rem) !important;
      line-height: 1.4 !important;
    }
    
    body.focus-mode-active .mc-btn,
    body.focus-mode-active .mc-btn-correct,
    body.focus-mode-active .mc-btn-incorrect,
    body.focus-mode-active .mc-btn-secondary {
      font-size: 1.125rem !important;
      padding: 1rem 1.5rem !important;
      margin-bottom: 0.625rem !important;
    }
    
    /* Answer buttons on desktop - bottom bar with more space */
    body.focus-mode-active #answer-buttons-section {
      padding: 1rem 2rem !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%) !important;
    }
    
    body.focus-mode-active #answer-buttons-section button {
      font-size: 1.125rem !important;
      padding: 1rem 2rem !important;
    }

    /* Navigation buttons on desktop */
    body.focus-mode-active #navigation-buttons {
      padding: 1rem 2rem !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%) !important;
    }

    body.focus-mode-active #navigation-buttons button {
      font-size: 1.125rem !important;
      padding: 1rem 2rem !important;
    }

    /* Progress bar on desktop */
    body.focus-mode-active #progress-section {
      padding: 1rem 2rem !important;
      max-width: 1200px !important;
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%) !important;
      top: 4rem !important;
    }
  }
  
  /* Clean scrollbar for Focus Mode */
  body.focus-mode-active #word-content::-webkit-scrollbar,
  body.focus-mode-active #definition-content::-webkit-scrollbar,
  body.focus-mode-active .mc-container::-webkit-scrollbar {
    width: 6px;
  }
  
  body.focus-mode-active #word-content::-webkit-scrollbar-track,
  body.focus-mode-active #definition-content::-webkit-scrollbar-track,
  body.focus-mode-active .mc-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }
  
  body.focus-mode-active #word-content::-webkit-scrollbar-thumb,
  body.focus-mode-active #definition-content::-webkit-scrollbar-thumb,
  body.focus-mode-active .mc-container::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }
  
  body.focus-mode-active #word-content::-webkit-scrollbar-thumb:hover,
  body.focus-mode-active #definition-content::-webkit-scrollbar-thumb:hover,
  body.focus-mode-active .mc-container::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
  }
  
  /* Firefox scrollbar */
  body.focus-mode-active #word-content,
  body.focus-mode-active #definition-content,
  body.focus-mode-active .mc-container {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) rgba(0, 0, 0, 0.05);
  }
  
  /* Custom scrollbar for content */
  #study-container.fullscreen-mode #word-content::-webkit-scrollbar,
  #study-container.fullscreen-mode #definition-content::-webkit-scrollbar {
    width: 8px;
  }
  
  #study-container.fullscreen-mode #word-content::-webkit-scrollbar-track,
  #study-container.fullscreen-mode #definition-content::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #study-container.fullscreen-mode #word-content::-webkit-scrollbar-thumb,
  #study-container.fullscreen-mode #definition-content::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }
  
  #study-container.fullscreen-mode #word-content::-webkit-scrollbar-thumb:hover,
  #study-container.fullscreen-mode #definition-content::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
  }
  
  /* Mobile fullscreen optimizations */
  @media (max-width: 768px) {
    #study-container.fullscreen-mode .flashcard {
      height: 98vh;
    }
    
    #study-container.fullscreen-mode #word-content,
    #study-container.fullscreen-mode #definition-content {
      font-size: clamp(1.25rem, 6vw, 2.5rem);
      padding: 0.75rem;
      max-height: calc(98vh - 180px);
    }
  }
  
  /* Answer buttons in fullscreen - fixed at bottom */
  #study-container.fullscreen-mode .flex.space-x-4 {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0;
    padding: 0.5rem;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 30;
  }
  
  #study-container.fullscreen-mode .flex.space-x-4 button {
    font-size: 1.25rem;
    padding: 1rem;
  }
  
  /* Note section in fullscreen - stays visible but compact */
  #study-container.fullscreen-mode #note-section {
    position: fixed;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    z-index: 40;
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  #study-container.fullscreen-mode #note-section textarea {
    max-height: 150px;
    font-size: 0.9rem;
  }
  
  @media (max-width: 768px) {
    #study-container.fullscreen-mode .flex.space-x-4 button {
      font-size: 1rem;
      padding: 0.75rem;
    }
  }
</style>
</style>
